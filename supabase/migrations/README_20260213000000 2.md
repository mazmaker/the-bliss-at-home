# Migration 20260213000000: Set Staff Status to Pending on Signup

## Overview
This migration updates the staff registration workflow to require admin approval before staff can start working. When a new staff member registers (via LINE, Google, or email), their staff record will be created with `status='pending'` instead of `status='active'`.

## Problem Statement
Previously, when staff registered via LINE login, the database trigger automatically created a staff record with `status='active'`, allowing them to immediately accept jobs without admin verification or document approval.

## Solution
Modified the `handle_new_staff_profile()` trigger function to set `staff.status='pending'` for all new staff registrations. This ensures:
1. Staff can login and access their profile
2. Staff can see their approval status via the eligibility dashboard
3. Staff cannot accept jobs until admin approves their account AND required documents are verified

## What Changed

### Updated Trigger Function
File: `20260213000000_set_staff_pending_on_signup.sql`

Changed line in `handle_new_staff_profile()`:
```sql
-- OLD
'active'::staff_status,  -- Set as active by default for LINE login

-- NEW
'pending'::staff_status, -- Set as pending for admin approval
```

## Staff Registration Workflow

### Before This Migration
1. Staff registers via LINE → `staff.status='active'`
2. Staff can immediately start accepting jobs ❌
3. No admin approval required ❌

### After This Migration
1. Staff registers via LINE → `staff.status='pending'`
2. Staff can login but sees "ยังไม่พร้อมรับงาน" (not ready to work) ✓
3. Admin reviews and approves account → `staff.status='active'` ✓
4. Staff uploads required documents (id_card, bank_statement) ✓
5. Admin verifies documents ✓
6. Staff can now accept jobs ✓

## Important Notes

### Profile vs Staff Status
- **`profiles.status`**: Controls login access (always 'ACTIVE' for successful registration)
- **`staff.status`**: Controls work eligibility (starts as 'pending', requires admin approval)

### Admin-Created Staff
Admin staff creation already sets `status='pending'` by default (see `apps/admin/src/services/staffService.ts:343`), so this change only affects self-registration flows (LINE, Google, email/password).

### Existing Staff Records
This migration does NOT change existing staff records. If you want to reset all existing staff to 'pending', uncomment the UPDATE block at the bottom of the migration file.

## How to Apply

### Local Development
```bash
cd supabase
supabase migration up
```

### Production (Supabase Dashboard)
1. Go to Supabase Dashboard → SQL Editor
2. Copy contents of `20260213000000_set_staff_pending_on_signup.sql`
3. Execute the SQL
4. Verify: Check that `handle_new_staff_profile()` function was updated

### Verify Migration
```sql
-- Check the trigger function
SELECT prosrc FROM pg_proc
WHERE proname = 'handle_new_staff_profile';

-- You should see 'pending'::staff_status in the function body
```

## Testing

1. **Test LINE Registration**:
   - Register a new staff via LINE login
   - Check that staff record has `status='pending'`
   - Login as staff and verify eligibility dashboard shows "not ready"
   - Login as admin and approve the staff account
   - Verify staff status changes to 'active'

2. **Test Admin Creation**:
   - Admin creates new staff from admin interface
   - Verify staff record has `status='pending'` (should already work)

## Related Files
- Migration: `supabase/migrations/20260213000000_set_staff_pending_on_signup.sql`
- Previous trigger: `supabase/migrations/20260212000000_auto_create_staff_record.sql`
- LINE login: `packages/supabase/src/auth/authService.ts` (loginWithLine function)
- Admin staff service: `apps/admin/src/services/staffService.ts` (createStaff function)
- Eligibility check: `packages/supabase/src/staff/staffService.ts` (canStaffStartWork function)
- Staff profile UI: `apps/staff/src/pages/StaffProfile.tsx` (eligibility dashboard)

## Rollback
To rollback this migration, restore the original trigger with `status='active'`:

```sql
CREATE OR REPLACE FUNCTION public.handle_new_staff_profile()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.role = 'STAFF' THEN
    INSERT INTO public.staff (
      profile_id, name_th, name_en, phone, avatar_url,
      status, created_at, updated_at
    ) VALUES (
      NEW.id,
      COALESCE(NEW.full_name, 'Staff'),
      COALESCE(NEW.full_name, 'Staff'),
      COALESCE(NEW.phone, '0000000000'),
      NEW.avatar_url,
      'active'::staff_status,  -- ROLLBACK: Changed back to active
      NOW(), NOW()
    )
    ON CONFLICT (profile_id) DO NOTHING;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## Impact
- **Breaking Changes**: None (existing functionality maintained)
- **User Experience**: Staff must wait for admin approval before working
- **Admin Workload**: Admins must now approve new staff registrations
- **Security**: Improved - prevents unauthorized staff from accepting jobs
