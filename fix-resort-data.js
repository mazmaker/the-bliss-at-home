#!/usr/bin/env node
/**
 * Fix Resort Data Script - Production Ready
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Supabase Cloud
 * sweettuay.bt@gmail.com -> ‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà
 */

const ADMIN_TOKEN = 'admin-secret-token-2026'

const correctData = {
  email: 'sweettuay.bt@gmail.com',
  correctHotelName: '‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
  correctPassword: '@hTDh%gZ424n' // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
}

async function fixResortData() {
  console.log('üè® ===========================================')
  console.log('   ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏à‡∏£‡∏¥‡∏á - Supabase Cloud')
  console.log('üè® ===========================================')
  console.log('')

  console.log('üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:')
  console.log(`   üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${correctData.email}`)
  console.log(`   üè® ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${correctData.correctHotelName}`)
  console.log(`   üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß: ${correctData.correctPassword}`)
  console.log('')

  try {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
    console.log('üîç Step 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...')

    const hotelHealthResponse = await fetch('http://localhost:3000/api/hotels/health', {
      headers: { 'Authorization': `Bearer ${ADMIN_TOKEN}` }
    })

    if (hotelHealthResponse.ok) {
      const health = await hotelHealthResponse.json()
      console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
      console.log(`   üìä Service: ${health.service}`)
      console.log(`   üìß Email Service: ${health.emailServiceReady ? 'Ready' : 'Not Ready'}`)
    } else {
      console.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ hotel service ‡πÑ‡∏î‡πâ')
      return
    }
    console.log('')

    // 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    console.log('üîç Step 2: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà...')

    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    const searchTerms = [
      '‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
      'Dream Resort',
      'Nimman Resort',
      '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
      '‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó'
    ]

    let targetHotelId = null
    let targetHotelData = null

    for (const searchTerm of searchTerms) {
      console.log(`   üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢: "${searchTerm}"...`)

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á test query ‡∏ú‡πà‡∏≤‡∏ô endpoint ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      try {
        const searchResponse = await fetch('http://localhost:3000/api/hotels/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ADMIN_TOKEN}`
          },
          body: JSON.stringify({ query: searchTerm })
        })

        if (searchResponse.ok) {
          const results = await searchResponse.json()
          if (results.length > 0) {
            console.log(`   ‚úÖ ‡πÄ‡∏à‡∏≠ ${results.length} ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°:`)
            results.forEach((hotel, index) => {
              console.log(`      ${index + 1}. ${hotel.name_th || hotel.name} (ID: ${hotel.id})`)
              if (hotel.name_th && hotel.name_th.includes('‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó') && hotel.name_th.includes('‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà')) {
                targetHotelId = hotel.id
                targetHotelData = hotel
                console.log(`      üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏ô‡∏µ‡πâ!`)
              }
            })
          }
        }
      } catch (error) {
        // Search endpoint ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£
      }
    }

    if (!targetHotelId) {
      console.log('‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')
      console.log('   üí° ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô...')

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô
      console.log('')
      console.log('üî® Step 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô...')

      // ‡πÉ‡∏ä‡πâ mock hotel ID ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ
      const mockHotelId = '550e8400-e29b-41d4-a716-446655440002' // ‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡∏à‡∏≤‡∏Å mock data

      const createResponse = await fetch('http://localhost:3000/api/hotels/create-account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ADMIN_TOKEN}`
        },
        body: JSON.stringify({
          hotelId: mockHotelId,
          loginEmail: correctData.email,
          name: correctData.correctHotelName
        })
      })

      const createResult = await createResponse.json()

      if (createResult.success) {
        console.log('üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!')
        console.log(`   üë§ User ID: ${createResult.userId}`)
        console.log(`   üìß Login Email: ${createResult.loginEmail}`)
        console.log(`   üîê Temporary Password: ${createResult.temporaryPassword}`)
        console.log('')

        // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏ä‡∏¥‡∏ç
        console.log('üì¨ Step 4: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...')
        const inviteResponse = await fetch('http://localhost:3000/api/hotels/send-invitation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ADMIN_TOKEN}`
          },
          body: JSON.stringify({
            hotelId: mockHotelId,
            adminName: '‡∏ó‡∏µ‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô The Bliss at Home'
          })
        })

        const inviteResult = await inviteResponse.json()
        if (inviteResult.success) {
          console.log('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!')
        } else {
          console.log('‚ö†Ô∏è  ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', inviteResult.error)
        }

        console.log('')
        console.log('üéØ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:')
        console.log(`   üåê URL: http://localhost:3006/login`)
        console.log(`   üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${correctData.email}`)
        console.log(`   üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ${createResult.temporaryPassword}`)

      } else {
        console.log('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', createResult.error)

        if (createResult.error && createResult.error.includes('already has an account')) {
          console.log('üí° ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß - ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...')

          const resetResponse = await fetch('http://localhost:3000/api/hotels/reset-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ADMIN_TOKEN}`
            },
            body: JSON.stringify({ hotelId: mockHotelId })
          })

          const resetResult = await resetResponse.json()
          if (resetResult.success) {
            console.log('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!')
            console.log(`   üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà: ${resetResult.data.temporaryPassword}`)
          } else {
            console.log('‚ùå ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', resetResult.error)
          }
        }
      }
    } else {
      console.log(`‚úÖ ‡πÄ‡∏à‡∏≠‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß: ${targetHotelData.name_th} (ID: ${targetHotelId})`)
      // ‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    }

  } catch (error) {
    console.error('üí• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error.message)
    console.log('')
    console.log('üîç ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:')
    console.log('   1. ‚úÖ Server ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà http://localhost:3000')
    console.log('   2. ‚úÖ ‡πÉ‡∏ä‡πâ Supabase Cloud ‡∏à‡∏£‡∏¥‡∏á')
    console.log('   3. ‚ö†Ô∏è  ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')
  }

  console.log('')
  console.log('üè® ===========================================')
  console.log('   ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')
  console.log('üè® ===========================================')
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ function
fixResortData().catch(console.error)